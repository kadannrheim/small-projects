#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Telegram Bot "–î–µ–Ω—å –≤ –∏—Å—Ç–æ—Ä–∏–∏" / "Day in History"
================================================

–ë–æ—Ç –ø—É–±–ª–∏–∫—É–µ—Ç –ø–æ—Å—Ç—ã, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –¥–∞—Ç–∞–º:
    - –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤ –∏–∑ JSON —Ñ–∞–π–ª–∞
    - –ü–æ–∏—Å–∫ –ø–æ—Å—Ç–∞ –ø–æ–¥ —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É (MM-DD)
    - –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram —Å –∫—Ä–∞—Å–∏–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    - –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –≤ –∑–∞–¥–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    - –ò—Å—Ç–æ—Ä–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤

–ê–≤—Ç–æ—Ä: kadannr
–í–µ—Ä—Å–∏—è: 1.0.0
"""

import json
import schedule
import time
import signal
import sys
import datetime
import logging
from typing import List, Dict, Optional, Any
from pathlib import Path

# –ò–º–ø–æ—Ä—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
from config import config
from utils import setup_logger, graceful_shutdown
from history import history
from formatter import format_post

# =============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ì–ï–†–ê
# =============================================================================

logger = setup_logger(__name__, config.log_level, config.log_file)
logger.info("=" * 60)
logger.info("üìÖ –ë–û–¢ '–î–ï–ù–¨ –í –ò–°–¢–û–†–ò–ò' –ó–ê–ü–£–©–ï–ù")
logger.info("=" * 60)


# =============================================================================
# –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
# =============================================================================

def load_posts() -> List[Dict[str, Any]]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å—Ç—ã –∏–∑ JSON —Ñ–∞–π–ª–∞.
    
    Returns:
        List[Dict]: –°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤. –ö–∞–∂–¥—ã–π –ø–æ—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç:
            - id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
            - person: –ò–º—è –ª–∏—á–Ω–æ—Å—Ç–∏
            - month_day: –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM-DD
            - title: –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞
            - content: –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
            - lesson: –£—Ä–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            - hashtags: –•—ç—à—Ç–µ–≥–∏
            - type: –¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            - mood: –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
    """
    data_path = Path(config.data_file)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    # -------------------------------------------------------------------------
    if not data_path.exists():
        logger.error(f"‚ùå –§–∞–π–ª —Å –ø–æ—Å—Ç–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: {data_path.absolute()}")
        logger.info("üí° –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª day_in_history.json –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ data/")
        return []
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ JSON
    # -------------------------------------------------------------------------
    try:
        with open(data_path, 'r', encoding='utf-8') as file:
            posts = json.load(file)
        
        logger.debug(f"–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, —Ç–∏–ø: {type(posts)}")
        
    except json.JSONDecodeError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
        return []
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Å—Ç–æ–≤: {e}")
        return []
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
    # -------------------------------------------------------------------------
    if not isinstance(posts, list):
        logger.error(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: –æ–∂–∏–¥–∞–ª—Å—è —Å–ø–∏—Å–æ–∫, –ø–æ–ª—É—á–µ–Ω {type(posts)}")
        return []
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 4: –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞
    # -------------------------------------------------------------------------
    valid_posts = []
    for idx, post in enumerate(posts):
        if not isinstance(post, dict):
            logger.warning(f"‚ö†Ô∏è –ü–æ—Å—Ç #{idx} –ø—Ä–æ–ø—É—â–µ–Ω: –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å–ª–æ–≤–∞—Ä–µ–º")
            continue
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        required_fields = ['title', 'content', 'person', 'month_day']
        missing_fields = [field for field in required_fields if field not in post]
        
        if missing_fields:
            logger.warning(f"‚ö†Ô∏è –ü–æ—Å—Ç #{idx} –ø—Ä–æ–ø—É—â–µ–Ω: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª—è {missing_fields}")
            continue
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã
        month_day = post.get('month_day', '')
        try:
            datetime.datetime.strptime(month_day, "%m-%d")
        except ValueError:
            logger.warning(f"‚ö†Ô∏è –ü–æ—Å—Ç #{idx} –ø—Ä–æ–ø—É—â–µ–Ω: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã '{month_day}' (—Ç—Ä–µ–±—É–µ—Ç—Å—è MM-DD)")
            continue
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        if 'hashtags' not in post or not post['hashtags']:
            post['hashtags'] = "#–¥–µ–Ω—å–≤–∏—Å—Ç–æ—Ä–∏–∏"
        
        if 'lesson' not in post:
            post['lesson'] = ""
        
        if 'type' not in post:
            post['type'] = "history"
        
        if 'mood' not in post:
            post['mood'] = "instructive"
        
        # –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫–∏
        post['title'] = post['title'].strip()
        post['content'] = post['content'].strip()
        post['person'] = post['person'].strip()
        post['hashtags'] = post['hashtags'].strip()
        if post['lesson']:
            post['lesson'] = post['lesson'].strip()
        
        valid_posts.append(post)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 5: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    # -------------------------------------------------------------------------
    if len(valid_posts) == 0:
        logger.error("‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –≤ —Ñ–∞–π–ª–µ!")
    else:
        logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(valid_posts)} –≤–∞–ª–∏–¥–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –∏–∑ {len(posts)}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –¥–∞—Ç–∞–º
        dates = sorted([p['month_day'] for p in valid_posts])
        logger.info(f"üìÖ –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç: —Å {dates[0]} –ø–æ {dates[-1]}")
    
    return valid_posts


# =============================================================================
# –ü–û–ò–°–ö –ü–û–°–¢–ê –ü–û –î–ê–¢–ï
# =============================================================================

def get_post_for_today(posts: List[Dict[str, Any]], check_history: bool = True) -> Optional[Dict[str, Any]]:
    """
    –ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Å—Ç –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã.
    
    Args:
        posts: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤
        check_history: –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—É–±–ª–∏–∫–∞—Ü–∏–π
        
    Returns:
        Optional[Dict]: –ü–æ—Å—Ç –∏–ª–∏ None
    """
    if not posts:
        logger.warning("‚ö†Ô∏è –°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤ –ø—É—Å—Ç")
        return None
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É
    # -------------------------------------------------------------------------
    today = datetime.datetime.now().strftime("%m-%d")
    logger.info(f"üìÖ –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞: {today}")
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –ò—â–µ–º –ø–æ—Å—Ç —Å —ç—Ç–æ–π –¥–∞—Ç–æ–π
    # -------------------------------------------------------------------------
    today_posts = [p for p in posts if p.get('month_day') == today]
    
    if not today_posts:
        logger.info(f"‚è≠Ô∏è –ù–µ—Ç –ø–æ—Å—Ç–∞ –¥–ª—è –¥–∞—Ç—ã {today}")
        return None
    
    logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(today_posts)} –ø–æ—Å—Ç–æ–≤ –¥–ª—è {today}")
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Å—Ç–æ–≤ –Ω–∞ –æ–¥–Ω—É –¥–∞—Ç—É - –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π
    # -------------------------------------------------------------------------
    selected_post = today_posts[0]
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    # -------------------------------------------------------------------------
    if check_history:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –∫–∞–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
        post_key = str(selected_post.get('id', ''))
        
        if history.is_published_recently(post_key, days=365):
            logger.warning(f"‚ö†Ô∏è –ü–æ—Å—Ç ID={post_key} —É–∂–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª—Å—è –≤ —ç—Ç–æ–º –≥–æ–¥—É")
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Å—Ç–æ–≤ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ
            if len(today_posts) > 1:
                logger.info("üîÑ –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π –ø–æ—Å—Ç –Ω–∞ —ç—Ç—É –∂–µ –¥–∞—Ç—É...")
                for alt_post in today_posts[1:]:
                    alt_key = str(alt_post.get('id', ''))
                    if not history.is_published_recently(alt_key, days=365):
                        logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Å—Ç ID={alt_key}")
                        return alt_post
            
            logger.warning(f"‚ùå –í—Å–µ –ø–æ—Å—Ç—ã –Ω–∞ {today} —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –≤ —ç—Ç–æ–º –≥–æ–¥—É")
            return None
    
    return selected_post


# =============================================================================
# –û–¢–ü–†–ê–í–ö–ê –í TELEGRAM
# =============================================================================

def send_post() -> bool:
    """
    –ù–∞—Ö–æ–¥–∏—Ç –ø–æ—Å—Ç –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Telegram –∫–∞–Ω–∞–ª.
    
    Returns:
        bool: True –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞
    """
    import requests
    
    logger.info("=" * 40)
    logger.info("üì§ –ù–ê–ß–ê–õ–û –ü–£–ë–õ–ò–ö–ê–¶–ò–ò")
    logger.info("=" * 40)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
    # -------------------------------------------------------------------------
    posts = load_posts()
    
    if not posts:
        logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å—Ç—ã")
        return False
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –ü–æ–∏—Å–∫ –ø–æ—Å—Ç–∞ –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
    # -------------------------------------------------------------------------
    post_data = get_post_for_today(posts, check_history=True)
    
    if not post_data:
        logger.error(f"‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã")
        return False
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    # -------------------------------------------------------------------------
    formatted_post = format_post(post_data)
    
    logger.info(f"üìù –ü–æ—Å—Ç –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {post_data['title']} ({post_data['person']})")
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
    # -------------------------------------------------------------------------
    url = f'https://api.telegram.org/bot{config.tg_bot_token}/sendMessage'
    
    payload = {
        'chat_id': config.tg_channel_id,
        'text': formatted_post,
        'parse_mode': 'HTML',
        'disable_web_page_preview': True
    }
    
    if config.disable_notifications:
        payload['disable_notification'] = True
    
    try:
        logger.debug(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Telegram API")
        
        response = requests.post(
            url, 
            data=payload, 
            timeout=config.request_timeout
        )
        
        if response.status_code == 200:
            result = response.json()
            
            if result.get('ok'):
                logger.info(f"‚úÖ –ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: {post_data['title']}")
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é (–∏—Å–ø–æ–ª—å–∑—É–µ–º ID –∫–∞–∫ –∫–ª—é—á)
                post_key = str(post_data.get('id', ''))
                history.mark_published(post_key)
                
                stats = history.get_stats()
                logger.info(f"üìà –í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π: {stats['total']}")
                
                logger.info("=" * 40)
                logger.info("‚úÖ –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û")
                logger.info("=" * 40)
                
                return True
            else:
                error_desc = result.get('description', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')
                logger.error(f"‚ùå Telegram API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: {error_desc}")
        else:
            logger.error(f"‚ùå HTTP –æ—à–∏–±–∫–∞: {response.status_code}")
            logger.error(f"–û—Ç–≤–µ—Ç API: {response.text[:200]}")
        
    except requests.exceptions.Timeout:
        logger.error("‚ùå –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞")
    except requests.exceptions.ConnectionError:
        logger.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Telegram API")
    except Exception as e:
        logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        logger.exception("–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:")
    
    logger.error("=" * 40)
    logger.error("‚ùå –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ù–ï –£–î–ê–õ–ê–°–¨")
    logger.error("=" * 40)
    
    return False


# =============================================================================
# –ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ü–£–ë–õ–ò–ö–ê–¶–ò–ô
# =============================================================================

def setup_daily_schedule() -> str:
    """
    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.
    """
    schedule.clear()
    
    publish_time = f"{config.publish_hour:02d}:{config.publish_minute:02d}"
    schedule.every().day.at(publish_time).do(send_post)
    
    logger.info(f"üìÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ {publish_time}")
    return publish_time


# =============================================================================
# –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# =============================================================================

def main():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.
    """
    signal.signal(signal.SIGINT, graceful_shutdown)
    signal.signal(signal.SIGTERM, graceful_shutdown)
    
    logger.info("=" * 60)
    logger.info("ü§ñ –ó–ê–ü–£–°–ö –ë–û–¢–ê '–î–ï–ù–¨ –í –ò–°–¢–û–†–ò–ò'")
    logger.info("=" * 60)
    
    # -------------------------------------------------------------------------
    # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    # -------------------------------------------------------------------------
    logger.info(f"üìÖ –í—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {config.publish_hour:02d}:{config.publish_minute:02d}")
    logger.info(f"üìÅ –§–∞–π–ª —Å –ø–æ—Å—Ç–∞–º–∏: {config.data_file}")
    logger.info(f"üìÅ –§–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏: {config.history_file}")
    
    # -------------------------------------------------------------------------
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    # -------------------------------------------------------------------------
    try:
        config.validate()
        logger.info("‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
    except ValueError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
        sys.exit(1)
    
    # -------------------------------------------------------------------------
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤
    # -------------------------------------------------------------------------
    posts = load_posts()
    if not posts:
        logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å—Ç—ã! –ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")
        sys.exit(1)
    
    # -------------------------------------------------------------------------
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–∞—Ç–∞–º
    # -------------------------------------------------------------------------
    unique_dates = len(set(p.get('month_day') for p in posts))
    logger.info(f"üìä –í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤: {len(posts)}, —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –¥–∞—Ç: {unique_dates}")
    
    # -------------------------------------------------------------------------
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
    # -------------------------------------------------------------------------
    stats = history.get_stats()
    logger.info(f"üìä –ò—Å—Ç–æ—Ä–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π: –≤—Å–µ–≥–æ {stats['total']} –∑–∞–ø–∏—Å–µ–π")
    
    # -------------------------------------------------------------------------
    # –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
    # -------------------------------------------------------------------------
    if config.send_test_post:
        logger.info("üß™ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞...")
        if send_post():
            logger.info("‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ")
        else:
            logger.warning("‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å")
    else:
        logger.info("‚è≠Ô∏è –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞")
    
    # -------------------------------------------------------------------------
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    # -------------------------------------------------------------------------
    publish_time = setup_daily_schedule()
    logger.info(f"‚úÖ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞: {publish_time}")
    
    # -------------------------------------------------------------------------
    # –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ
    # -------------------------------------------------------------------------
    logger.info("=" * 60)
    logger.info("‚úÖ –ë–û–¢ –ó–ê–ü–£–©–ï–ù –ò –û–ñ–ò–î–ê–ï–¢ –ü–£–ë–õ–ò–ö–ê–¶–ò–ô")
    logger.info("=" * 60)
    
    while True:
        try:
            schedule.run_pending()
            time.sleep(60)
            
        except KeyboardInterrupt:
            logger.info("üëã –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è, –∑–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É...")
            break
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ: {e}")
            time.sleep(60)


# =============================================================================
# –¢–û–ß–ö–ê –í–•–û–î–ê
# =============================================================================

if __name__ == "__main__":
    main()