#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Telegram Quotes Bot - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Ü–∏—Ç–∞—Ç –≤ Telegram –∫–∞–Ω–∞–ª
=======================================================================

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–ª—è –±–æ—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ü–∏—Ç–∞—Ç.
–û–Ω –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:
    - –ó–∞–≥—Ä—É–∑–∫—É —Ü–∏—Ç–∞—Ç –∏–∑ JSON —Ñ–∞–π–ª–∞
    - –í—ã–±–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ü–∏—Ç–∞—Ç (–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤ 365 –¥–Ω–µ–π)
    - –û—Ç–ø—Ä–∞–≤–∫—É –≤ Telegram –∫–∞–Ω–∞–ª –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
    - –û–±—Ä–∞–±–æ—Ç–∫—É —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è graceful shutdown
    - –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π —Å–æ —Å–ª—É—á–∞–π–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º

–ê–≤—Ç–æ—Ä: kadannr
–í–µ—Ä—Å–∏—è: 1.0.0
–õ–∏—Ü–µ–Ω–∑–∏—è: MIT

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
    $ python bot.py
    –∏–ª–∏ —á–µ—Ä–µ–∑ Docker:
    $ docker-compose up -d
"""

import json
import random
import schedule
import time
import signal
import sys
import datetime
import logging
from typing import List, Dict, Optional, Any
from pathlib import Path

# –ò–º–ø–æ—Ä—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
from config import config  # –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
from utils import setup_logger, graceful_shutdown  # –£—Ç–∏–ª–∏—Ç—ã
from history import history  # –ò—Å—Ç–æ—Ä–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π

# =============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ì–ï–†–ê
# =============================================================================

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —É—Ç–∏–ª–∏—Ç—ã setup_logger
# –õ–æ–≥–∏ –±—É–¥—É—Ç –ø–∏—Å–∞—Ç—å—Å—è:
#   - –≤ –∫–æ–Ω—Å–æ–ª—å (stdout) –¥–ª—è Docker
#   - –≤ —Ñ–∞–π–ª –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
logger = setup_logger(__name__, config.log_level, config.log_file)
logger.info("=" * 60)
logger.info("üöÄ –ë–û–¢ –¶–ò–¢–ê–¢ –ó–ê–ü–£–©–ï–ù")
logger.info("=" * 60)


# =============================================================================
# –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
# =============================================================================

def load_quotes() -> List[Dict[str, Any]]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ü–∏—Ç–∞—Ç—ã –∏–∑ JSON —Ñ–∞–π–ª–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫.
    
    –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö:
        1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        2. –ü—ã—Ç–∞–µ—Ç—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON
        3. –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
        4. –î–æ–±–∞–≤–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π
    
    Returns:
        List[Dict]: –°–ø–∏—Å–æ–∫ —Ü–∏—Ç–∞—Ç. –ö–∞–∂–¥–∞—è —Ü–∏—Ç–∞—Ç–∞ - —Å–ª–æ–≤–∞—Ä—å —Å –∫–ª—é—á–∞–º–∏:
            - text (str): –¢–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π)
            - author (str): –ê–≤—Ç–æ—Ä —Ü–∏—Ç–∞—Ç—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä")
            - hashtag (str): –•—ç—à—Ç–µ–≥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "#—Ü–∏—Ç–∞—Ç—ã")
    
    Examples:
        >>> quotes = load_quotes()
        >>> if quotes:
        ...     print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(quotes)} —Ü–∏—Ç–∞—Ç")
        ...     first_quote = quotes[0]
        ...     print(first_quote['text'])
    
    Note:
        –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∏ –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É.
        –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É (–∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è).
    """
    quotes_path = Path(config.quotes_file)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    # -------------------------------------------------------------------------
    if not quotes_path.exists():
        logger.error(f"‚ùå –§–∞–π–ª —Ü–∏—Ç–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: {quotes_path.absolute()}")
        logger.info("üí° –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª quotes365.json –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –≤ .env")
        logger.info("üí° –ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞: [{\"text\": \"...\", \"author\": \"...\"}]")
        return []
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ JSON
    # -------------------------------------------------------------------------
    try:
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–¥–∏—Ä–æ–≤–∫–∏ (–≤–∞–∂–Ω–æ –¥–ª—è Windows)
        with open(quotes_path, 'r', encoding='utf-8') as file:
            quotes = json.load(file)
        
        logger.debug(f"–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, —Ç–∏–ø: {type(quotes)}")
        
    except json.JSONDecodeError as e:
        # –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON - —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
        logger.error(f"   –ü–æ–∑–∏—Ü–∏—è –æ—à–∏–±–∫–∏: —Å—Ç—Ä–æ–∫–∞ {e.lineno}, –∫–æ–ª–æ–Ω–∫–∞ {e.colno}")
        logger.error("üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫")
        return []
    except PermissionError:
        # –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
        logger.error(f"‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞: {quotes_path}")
        logger.error("üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É")
        return []
    except Exception as e:
        # –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞
        logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ü–∏—Ç–∞—Ç: {e}")
        return []
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
    # -------------------------------------------------------------------------
    if not isinstance(quotes, list):
        logger.error(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: –æ–∂–∏–¥–∞–ª—Å—è —Å–ø–∏—Å–æ–∫, –ø–æ–ª—É—á–µ–Ω {type(quotes)}")
        logger.error("üí° –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å JSON –º–∞—Å—Å–∏–≤: [...]")
        return []
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 4: –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞–∂–¥–æ–π —Ü–∏—Ç–∞—Ç—ã –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    # -------------------------------------------------------------------------
    valid_quotes = []
    for idx, quote in enumerate(quotes):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–∏—Ç–∞—Ç–∞ - —Å–ª–æ–≤–∞—Ä—å
        if not isinstance(quote, dict):
            logger.warning(f"‚ö†Ô∏è –¶–∏—Ç–∞—Ç–∞ #{idx} –ø—Ä–æ–ø—É—â–µ–Ω–∞: –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å–ª–æ–≤–∞—Ä–µ–º (—Ç–∏–ø: {type(quote)})")
            continue
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è 'text'
        if 'text' not in quote or not quote['text']:
            logger.warning(f"‚ö†Ô∏è –¶–∏—Ç–∞—Ç–∞ #{idx} –ø—Ä–æ–ø—É—â–µ–Ω–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç")
            continue
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
        if 'author' not in quote or not quote['author']:
            quote['author'] = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä"
            logger.debug(f"–î–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ü–∏—Ç–∞—Ç—ã #{idx}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ö—ç—à—Ç–µ–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
        if 'hashtag' not in quote or not quote['hashtag']:
            quote['hashtag'] = "#—Ü–∏—Ç–∞—Ç—ã"
            logger.debug(f"–î–æ–±–∞–≤–ª–µ–Ω —Ö—ç—à—Ç–µ–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ü–∏—Ç–∞—Ç—ã #{idx}")
        
        # –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
        quote['text'] = quote['text'].strip()
        quote['author'] = quote['author'].strip()
        quote['hashtag'] = quote['hashtag'].strip()
        
        valid_quotes.append(quote)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 5: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    # -------------------------------------------------------------------------
    if len(valid_quotes) == 0:
        logger.error("‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —Ü–∏—Ç–∞—Ç –≤ —Ñ–∞–π–ª–µ!")
    else:
        logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(valid_quotes)} –≤–∞–ª–∏–¥–Ω—ã—Ö —Ü–∏—Ç–∞—Ç –∏–∑ {len(quotes)}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–π —Ü–∏—Ç–∞—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        if valid_quotes and logger.isEnabledFor(logging.DEBUG):
            example = valid_quotes[0]
            logger.debug(f"–ü—Ä–∏–º–µ—Ä —Ü–∏—Ç–∞—Ç—ã: {example['text'][:50]}... - {example['author']}")
    
    return valid_quotes


# =============================================================================
# –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –¶–ò–¢–ê–¢
# =============================================================================

def get_unique_quote(quotes: List[Dict[str, Any]]) -> Optional[Dict[str, Any]]:
    """
    –í—ã–±–∏—Ä–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Ü–∏—Ç–∞—Ç—É —Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–æ–≤—Ç–æ—Ä–æ–≤ –≤ —Ç–µ—á–µ–Ω–∏–µ –≥–æ–¥–∞.
    
    –≠—Ç–æ –∫–ª—é—á–µ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±–æ—Ç–∞, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∞—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
    –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:
        1. –ü–æ–ª—É—á–∞–µ—Ç –∏–∑ history —Å–ø–∏—Å–æ–∫ —Ü–∏—Ç–∞—Ç, –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–≤—à–∏—Ö—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ 365 –¥–Ω–µ–π
        2. –ï—Å–ª–∏ —Ç–∞–∫–∏–µ –µ—Å—Ç—å - –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –∏–∑ –Ω–∏—Ö
        3. –ï—Å–ª–∏ –Ω–µ—Ç - —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –Ω–æ–≤—ã–π –≥–æ–¥–æ–≤–æ–π —Ü–∏–∫–ª
    
    Args:
        quotes: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ü–∏—Ç–∞—Ç
        
    Returns:
        Optional[Dict]: –í—ã–±—Ä–∞–Ω–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ –∏–ª–∏ None –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç
        
    Examples:
        >>> quotes = load_quotes()
        >>> quote = get_unique_quote(quotes)
        >>> if quote:
        ...     print(f"–í—ã–±—Ä–∞–Ω–∞: {quote['text']}")
    
    Note:
        –§—É–Ω–∫—Ü–∏—è –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ü–∏—Ç–∞—Ç—É, –µ—Å–ª–∏ quotes –Ω–µ –ø—É—Å—Ç.
        –ü—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –≤—Å–µ—Ö —Ü–∏—Ç–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ü–∏–∫–ª.
    """
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —Ü–∏—Ç–∞—Ç
    if not quotes:
        logger.warning("‚ö†Ô∏è –°–ø–∏—Å–æ–∫ —Ü–∏—Ç–∞—Ç –ø—É—Å—Ç, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ü–∏—Ç–∞—Ç—É")
        return None
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ü–∏—Ç–∞—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
    # -------------------------------------------------------------------------
    # days=365 –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ü–∏—Ç–∞—Ç–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–æ–π, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å
    # –ø–æ—Å–ª–µ–¥–Ω–∏–µ 365 –¥–Ω–µ–π (–∏–ª–∏ –≤–æ–æ–±—â–µ –Ω–∏–∫–æ–≥–¥–∞)
    available_quotes = history.get_available_quotes(quotes, days=365)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –†–∞—Å—á–µ—Ç –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    # -------------------------------------------------------------------------
    total_quotes = len(quotes)
    used_quotes = total_quotes - len(available_quotes)
    usage_percent = (used_quotes / total_quotes) * 100 if total_quotes > 0 else 0
    
    logger.info(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–∏–∫–ª–∞: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ {used_quotes}/{total_quotes} —Ü–∏—Ç–∞—Ç ({usage_percent:.1f}%)")
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –í—ã–±–æ—Ä —Ü–∏—Ç–∞—Ç—ã (–¥–≤–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—É—Ç–∏)
    # -------------------------------------------------------------------------
    if available_quotes:
        # –ü–£–¢–¨ 1: –ï—Å—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã - –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é
        selected_quote = random.choice(available_quotes)
        logger.info(f"‚úÖ –í—ã–±—Ä–∞–Ω–∞ —Ü–∏—Ç–∞—Ç–∞ –∏–∑ {len(available_quotes)} –¥–æ—Å—Ç—É–ø–Ω—ã—Ö")
        
        # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
        if logger.isEnabledFor(logging.DEBUG):
            logger.debug(f"–í—ã–±—Ä–∞–Ω–∞: {selected_quote['text'][:100]}...")
        
        return selected_quote
    
    # –ü–£–¢–¨ 2: –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ü–∏—Ç–∞—Ç - –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —Ü–∏–∫–ª
    logger.info("üîÑ –í—Å–µ —Ü–∏—Ç–∞—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã! –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –≥–æ–¥–æ–≤–æ–π —Ü–∏–∫–ª...")
    logger.info("üìÜ –°–±—Ä–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–π...")
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é - —Ç–µ–ø–µ—Ä—å –≤—Å–µ —Ü–∏—Ç–∞—Ç—ã —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–Ω—ã
    history.reset_history()
    
    # –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –≤—Å–µ —Ü–∏—Ç–∞—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é —Ü–∏—Ç–∞—Ç—É –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
    selected_quote = random.choice(quotes)
    logger.info(f"‚úÖ –í—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è —Ü–∏—Ç–∞—Ç–∞ –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞")
    
    return selected_quote


def format_quote(quote_data: Dict[str, Any]) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ü–∏—Ç–∞—Ç—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram.
    
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ —Ü–∏—Ç–∞—Ç—ã –≤ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
    —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Telegram.
    
    Args:
        quote_data: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ —Ü–∏—Ç–∞—Ç—ã (text, author, hashtag)
        
    Returns:
        str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        
    Format:
        {—Ç–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã}
        
        {–∞–≤—Ç–æ—Ä}
        
        {—Ö—ç—à—Ç–µ–≥}
        
    Examples:
        >>> quote = {"text": "Hello", "author": "World", "hashtag": "#test"}
        >>> print(format_quote(quote))
        Hello
        
        World
        
        #test
    
    Note:
        –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã –ø—É—Å—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
    """
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    # -------------------------------------------------------------------------
    # .get() –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ —á–µ–º –ø—Ä—è–º—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è, —Ç.–∫. –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç KeyError
    text = quote_data.get('text', '').strip()
    author = quote_data.get('author', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä').strip()
    hashtag = quote_data.get('hashtag', '#—Ü–∏—Ç–∞—Ç—ã').strip()
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –í–∞–ª–∏–¥–∞—Ü–∏—è
    # -------------------------------------------------------------------------
    if not text:
        logger.warning("‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–∏—Ç–∞—Ç—É –±–µ–∑ —Ç–µ–∫—Å—Ç–∞")
        return ""
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    # -------------------------------------------------------------------------
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–≤–æ–π–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—Å—Ç—É–ø–æ–≤ –≤ Telegram
    formatted = f"{text}\n\n{author}\n\n{hashtag}"
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 4: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ DEBUG)
    # -------------------------------------------------------------------------
    if logger.isEnabledFor(logging.DEBUG):
        logger.debug(f"–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ü–∏—Ç–∞—Ç–∞: {text[:50]}...")
    
    return formatted


# =============================================================================
# –û–¢–ü–†–ê–í–ö–ê –í TELEGRAM
# =============================================================================

def send_quote() -> bool:
    """
    –í—ã–±–∏—Ä–∞–µ—Ç —Ü–∏—Ç–∞—Ç—É –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–µ –≤ Telegram –∫–∞–Ω–∞–ª.
    
    –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:
        1. –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ü–∏—Ç–∞—Ç
        2. –í—ã–±–∏—Ä–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Ü–∏—Ç–∞—Ç—É —á–µ—Ä–µ–∑ get_unique_quote()
        3. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ format_quote()
        4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Telegram —á–µ—Ä–µ–∑ Bot API
        5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ history.mark_published()
    
    Returns:
        bool: True –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞, False –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ
        
    Note:
        –§—É–Ω–∫—Ü–∏—è –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π –Ω–∞—Ä—É–∂—É, –≤—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è.
        –ü—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö –æ—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É.
    
    Example:
        >>> success = send_quote()
        >>> if success:
        ...     print("–¶–∏—Ç–∞—Ç–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!")
    """
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º requests —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤
    # –∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–º–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏)
    import requests
    
    logger.info("=" * 40)
    logger.info("üì§ –ù–ê–ß–ê–õ–û –ü–£–ë–õ–ò–ö–ê–¶–ò–ò –¶–ò–¢–ê–¢–´")
    logger.info("=" * 40)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–∏—Ç–∞—Ç
    # -------------------------------------------------------------------------
    quotes = load_quotes()
    
    if not quotes:
        logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ü–∏—Ç–∞—Ç—ã, –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞")
        return False
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –í—ã–±–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Ü–∏—Ç–∞—Ç—ã
    # -------------------------------------------------------------------------
    quote_data = get_unique_quote(quotes)
    
    if not quote_data:
        logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å —Ü–∏—Ç–∞—Ç—É, –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞")
        return False
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    # -------------------------------------------------------------------------
    formatted_quote = format_quote(quote_data)
    quote_text = quote_data.get('text', '')
    
    if not formatted_quote:
        logger.error("‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–∏—Ç–∞—Ç—ã")
        return False
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —Ü–∏—Ç–∞—Ç—ã –≤ –ª–æ–≥–µ
    logger.info(f"üìù –¶–∏—Ç–∞—Ç–∞ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {quote_text[:100]}..." + ("..." if len(quote_text) > 100 else ""))
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
    # -------------------------------------------------------------------------
    # –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è Telegram Bot API
    url = f'https://api.telegram.org/bot{config.tg_q_bot_token}/sendMessage'
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º payload (—Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞)
    payload = {
        'chat_id': config.tg_q_channel_id,  # ID –∫–∞–Ω–∞–ª–∞
        'text': formatted_quote,            # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        'parse_mode': 'HTML',                # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        'disable_web_page_preview': True     # –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Å—ã–ª–æ–∫
    }
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
    if hasattr(config, 'disable_notifications') and config.disable_notifications:
        payload['disable_notification'] = True
    
    try:
        # ---------------------------------------------------------------------
        # –®–∞–≥ 4.1: –û—Ç–ø—Ä–∞–≤–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–∞
        # ---------------------------------------------------------------------
        logger.debug(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Telegram API: {url}")
        logger.debug(f"Payload: {payload}")  # –í–Ω–∏–º–∞–Ω–∏–µ: –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        response = requests.post(
            url, 
            data=payload, 
            timeout=getattr(config, 'request_timeout', 10)  # –¢–∞–π–º–∞—É—Ç –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –∏–ª–∏ 10 —Å–µ–∫
        )
        
        # ---------------------------------------------------------------------
        # –®–∞–≥ 4.2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
        # ---------------------------------------------------------------------
        if response.status_code == 200:
            # –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API
            result = response.json()
            
            if result.get('ok'):
                logger.info("‚úÖ –¶–∏—Ç–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ Telegram!")
                
                # -----------------------------------------------------------------
                # –®–∞–≥ 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                # -----------------------------------------------------------------
                # –û—Ç–º–µ—á–∞–µ–º —Ü–∏—Ç–∞—Ç—É –∫–∞–∫ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—É—é
                history.mark_published(quote_text)
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                stats = history.get_stats()
                logger.info(f"üìà –í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π: {stats['total']}")
                
                if stats.get('last_30_days'):
                    logger.info(f"üìà –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π: {stats['last_30_days']}")
                
                logger.info("=" * 40)
                logger.info("‚úÖ –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û")
                logger.info("=" * 40)
                
                return True
            else:
                # API –≤–µ—Ä–Ω—É–ª–æ –æ—à–∏–±–∫—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω)
                error_desc = result.get('description', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')
                logger.error(f"‚ùå Telegram API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: {error_desc}")
        else:
            # HTTP –æ—à–∏–±–∫–∞ (4xx, 5xx)
            logger.error(f"‚ùå HTTP –æ—à–∏–±–∫–∞: {response.status_code}")
            logger.error(f"–û—Ç–≤–µ—Ç API: {response.text[:200]}")  # –ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤
        
    except requests.exceptions.Timeout:
        # –¢–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        logger.error("‚ùå –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ Telegram API")
        logger.info("üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ timeout –≤ –∫–æ–Ω—Ñ–∏–≥–µ")
        
    except requests.exceptions.ConnectionError:
        # –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, DNS –Ω–µ —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è)
        logger.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Telegram API")
        logger.info("üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å api.telegram.org")
        
    except requests.exceptions.RequestException as e:
        # –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ requests
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {e}")
        
    except Exception as e:
        # –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞
        logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: {e}")
        # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π —Å—Ç–µ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        logger.exception("–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:")
    
    # –ï—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ —Å—é–¥–∞ - –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
    logger.error("=" * 40)
    logger.error("‚ùå –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ù–ï –£–î–ê–õ–ê–°–¨")
    logger.error("=" * 40)
    
    return False


# =============================================================================
# –ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ü–£–ë–õ–ò–ö–ê–¶–ò–ô
# =============================================================================

def schedule_random_time() -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ.
    
    –ê–ª–≥–æ—Ä–∏—Ç–º:
        1. –ë–µ—Ä–µ–º –±–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è (base_hour:base_minute –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
        2. –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö ¬±random_range_minutes
        3. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –≤—ã–π—Ç–∏ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã —Å—É—Ç–æ–∫ (00:00 - 23:59)
    
    Returns:
        str: –í—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ "HH:MM" –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ schedule
        
    Example:
        >>> config.base_hour = 9
        >>> config.base_minute = 0
        >>> config.random_range_minutes = 30
        >>> schedule_random_time()
        '09:15'  # –∏–ª–∏ '08:45' –∏–ª–∏ '09:30' –∏ —Ç.–¥.
    
    Note:
        –†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –≤ schedule.
    """
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–º–µ—â–µ–Ω–∏—è
    # -------------------------------------------------------------------------
    # random.randint –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç -N –¥–æ N –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ
    random_offset = random.randint(-config.random_range_minutes, config.random_range_minutes)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö –æ—Ç –ø–æ–ª—É–Ω–æ—á–∏
    # -------------------------------------------------------------------------
    # –ü–µ—Ä–µ–≤–æ–¥–∏–º –±–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç—ã
    base_minutes = config.base_hour * 60 + config.base_minute
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ
    total_minutes = base_minutes + random_offset
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –≥—Ä–∞–Ω–∏—Ü —Å—É—Ç–æ–∫
    # -------------------------------------------------------------------------
    # –ù–µ –¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–∏ —É–π—Ç–∏ –¥–æ 00:00
    total_minutes = max(0, total_minutes)
    
    # –ù–µ –¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–∏ —É–π—Ç–∏ –∑–∞ 23:59
    total_minutes = min(total_minutes, 23 * 60 + 59)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 4: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ —á–∞—Å—ã –∏ –º–∏–Ω—É—Ç—ã
    # -------------------------------------------------------------------------
    target_hour = total_minutes // 60
    target_minute = total_minutes % 60
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 5: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    # -------------------------------------------------------------------------
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å –≤–µ–¥—É—â–∏–º–∏ –Ω—É–ª—è–º–∏ (9:5 -> 09:05)
    target_time = f"{target_hour:02d}:{target_minute:02d}"
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 6: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    # -------------------------------------------------------------------------
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–Ω–∞–∫ —Å–º–µ—â–µ–Ω–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    offset_sign = '+' if random_offset >= 0 else ''
    
    logger.info(f"üïí –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {target_time} "
                f"(—Å–º–µ—â–µ–Ω–∏–µ: {offset_sign}{random_offset} –º–∏–Ω—É—Ç –æ—Ç "
                f"{config.base_hour:02d}:{config.base_minute:02d})")
    
    return target_time


def setup_daily_schedule() -> str:
    """
    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ —Å–ª—É—á–∞–π–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º.
    
    –§—É–Ω–∫—Ü–∏—è:
        1. –û—á–∏—â–∞–µ—Ç –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
        2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è —á–µ—Ä–µ–∑ schedule_random_time()
        3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º—è
    
    Returns:
        str: –í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        
    Note:
        –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ –ø–æ–ª–Ω–æ—á—å –¥–ª—è –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏,
        –∞ —Ç–∞–∫–∂–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞.
    """
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞–Ω–∏–π
    # -------------------------------------------------------------------------
    # schedule.clear() —É–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ä–∞–Ω–µ–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
    # –≠—Ç–æ –≤–∞–∂–Ω–æ –ø—Ä–∏ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–µ –≤ –Ω–æ–≤—ã–π –¥–µ–Ω—å
    schedule.clear()
    logger.debug("–û—á–∏—â–µ–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞")
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    # -------------------------------------------------------------------------
    random_time = schedule_random_time()
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞–Ω–∏—è
    # -------------------------------------------------------------------------
    # schedule.every().day.at(time).do(function) - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ
    # –§—É–Ω–∫—Ü–∏—è send_quote –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ random_time
    schedule.every().day.at(random_time).do(send_quote)
    
    logger.info(f"üìÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ {random_time}")
    
    return random_time


# =============================================================================
# –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# =============================================================================

def main():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.
    
    –í—ã–ø–æ–ª–Ω—è–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∏ –∑–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞:
        1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤ (SIGINT, SIGTERM)
        2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        3. –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–∏—Ç–∞—Ç
        4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        5. –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        7. –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–¥–∞–Ω–∏–π
    
    –≠—Ç–æ—Ç –¥–∏–∑–∞–π–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
        - Graceful shutdown –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
        - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫
        - –ü–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
        - –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ (sleep 60s)
    """
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤
    # -------------------------------------------------------------------------
    # SIGINT - —Å–∏–≥–Ω–∞–ª –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (Ctrl+C)
    # SIGTERM - —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (docker stop, systemctl stop)
    signal.signal(signal.SIGINT, graceful_shutdown)
    signal.signal(signal.SIGTERM, graceful_shutdown)
    
    logger.info("=" * 60)
    logger.info("ü§ñ –ó–ê–ü–£–°–ö –ë–û–¢–ê –ü–£–ë–õ–ò–ö–ê–¶–ò–ò –¶–ò–¢–ê–¢")
    logger.info("=" * 60)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    # -------------------------------------------------------------------------
    logger.info(f"üìÖ –ë–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è: {config.base_hour:02d}:{config.base_minute:02d}")
    logger.info(f"üé≤ –°–ª—É—á–∞–π–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: ¬±{config.random_range_minutes} –º–∏–Ω—É—Ç")
    logger.info(f"üìÅ –§–∞–π–ª —Ü–∏—Ç–∞—Ç: {config.quotes_file}")
    logger.info(f"üìÅ –§–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏: {config.history_file}")
    logger.info(f"üìù –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {config.log_level}")
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    # -------------------------------------------------------------------------
    try:
        config.validate()
        logger.info("‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
    except ValueError as e:
        # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ - –±–µ–∑ –≤–∞–ª–∏–¥–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
        logger.error("üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env —Ñ–∞–π–ª –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:")
        logger.error("   - TG_Q_BOT_TOKEN (—Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç @BotFather)")
        logger.error("   - TG_Q_CHANNEL_ID (ID –∫–∞–Ω–∞–ª–∞)")
        sys.exit(1)  # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–∏—Ç–∞—Ç
    # -------------------------------------------------------------------------
    quotes = load_quotes()
    if not quotes:
        # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ - –±–µ–∑ —Ü–∏—Ç–∞—Ç –±–æ—Ç –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω
        logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ü–∏—Ç–∞—Ç—ã! –ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")
        logger.error("üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ñ–∞–π–ª quotes365.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã")
        sys.exit(1)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 5: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
    # -------------------------------------------------------------------------
    stats = history.get_stats()
    logger.info(f"üìä –ò—Å—Ç–æ—Ä–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π:")
    logger.info(f"   - –í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ü–∏—Ç–∞—Ç: {stats['total']}")
    
    if stats['total'] > 0:
        logger.info(f"   - –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π: {stats['last_30_days']}")
        logger.info(f"   - –ü–µ—Ä–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è: {stats.get('oldest', 'N/A')}")
        logger.info(f"   - –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è: {stats.get('newest', 'N/A')}")
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 6: –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    # -------------------------------------------------------------------------
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞—Ç—Ä–∏–±—É—Ç send_test_quote –≤ –∫–æ–Ω—Ñ–∏–≥–µ
    send_test = getattr(config, 'send_test_quote', True)
    
    if send_test:
        logger.info("üß™ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Ü–∏—Ç–∞—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏...")
        if send_quote():
            logger.info("‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ")
        else:
            logger.warning("‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram")
    else:
        logger.info("‚è≠Ô∏è –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏")
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    # -------------------------------------------------------------------------
    today_time = setup_daily_schedule()
    logger.info(f"‚úÖ –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞: {today_time}")
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 8: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥–∞—Ç—ã
    # -------------------------------------------------------------------------
    last_check_date = datetime.datetime.now().date()
    
    logger.info("=" * 60)
    logger.info("‚úÖ –ë–û–¢ –£–°–ü–ï–®–ù–û –ó–ê–ü–£–©–ï–ù –ò –û–ñ–ò–î–ê–ï–¢ –ü–£–ë–õ–ò–ö–ê–¶–ò–ô")
    logger.info("=" * 60)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 9: –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ
    # -------------------------------------------------------------------------
    while True:
        try:
            # -----------------------------------------------------------------
            # –®–∞–≥ 9.1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã –¥–∞—Ç—ã
            # -----------------------------------------------------------------
            current_date = datetime.datetime.now().date()
            
            # –ï—Å–ª–∏ –Ω–∞—Å—Ç—É–ø–∏–ª –Ω–æ–≤—ã–π –¥–µ–Ω—å
            if current_date != last_check_date:
                logger.info("üìÖ –ù–æ–≤—ã–π –¥–µ–Ω—å! –ü–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é...")
                
                # –ü–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä—É–µ–º –Ω–∞ –Ω–æ–≤—ã–π –¥–µ–Ω—å
                new_time = setup_daily_schedule()
                logger.info(f"‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞: {new_time}")
                
                last_check_date = current_date
            
            # -----------------------------------------------------------------
            # –®–∞–≥ 9.2: –ó–∞–ø—É—Å–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π
            # -----------------------------------------------------------------
            # schedule.run_pending() –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∑–∞–¥–∞–Ω–∏—è,
            # –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å–µ–π—á–∞—Å, –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏—Ö
            schedule.run_pending()
            
            # -----------------------------------------------------------------
            # –®–∞–≥ 9.3: –°–æ–Ω –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
            # -----------------------------------------------------------------
            # –°–ø–∏–º 60 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
            # –≠—Ç–æ –Ω–∞–º–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ, —á–µ–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ–≤–µ—Ä–∫–∏
            time.sleep(60)
            
        except KeyboardInterrupt:
            # Ctrl+C
            logger.info("üëã –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (Ctrl+C), –∑–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É...")
            break
            
        except Exception as e:
            # –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ: {e}")
            logger.exception("–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:")
            logger.info("üîÑ –ü—Ä–æ–¥–æ–ª–∂–∞—é —Ä–∞–±–æ—Ç—É –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏...")
            
            # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±—ã—Å—Ç—Ä–æ–≥–æ —Ü–∏–∫–ª–∞ –æ—à–∏–±–æ–∫
            time.sleep(60)


# =============================================================================
# –¢–û–ß–ö–ê –í–•–û–î–ê
# =============================================================================

if __name__ == "__main__":
    """
    –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∫—Ä–∏–ø—Ç–∞.
    
    –≠—Ç–æ—Ç –±–ª–æ–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Ñ–∞–π–ª –∑–∞–ø—É—â–µ–Ω –Ω–∞–ø—Ä—è–º—É—é:
        $ python bot.py
    
    –ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è (import bot) —ç—Ç–æ—Ç –∫–æ–¥ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.
    """
    main()
# =============================================================================
# –ö–û–ù–ï–¶ –§–ê–ô–õ–ê
# =============================================================================