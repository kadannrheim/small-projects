#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
–ú–æ–¥—É–ª—å –∏—Å—Ç–æ—Ä–∏–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–π —Ü–∏—Ç–∞—Ç
================================

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ç–æ–≥–æ, –∫–∞–∫–∏–µ —Ü–∏—Ç–∞—Ç—ã –±—ã–ª–∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –∏ –∫–æ–≥–¥–∞.
–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (365 –¥–Ω–µ–π).

–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
    - –ó–∞–≥—Ä—É–∑–∫–∞/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤ JSON —Ñ–∞–π–ª
    - –ü—Ä–æ–≤–µ—Ä–∫–∞, –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å –ª–∏ —Ü–∏—Ç–∞—Ç–∞ –Ω–µ–¥–∞–≤–Ω–æ
    - –û—Ç–º–µ—Ç–∫–∞ —Ü–∏—Ç–∞—Ç—ã –∫–∞–∫ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π
    - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö (–Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–≤—à–∏—Ö—Å—è) —Ü–∏—Ç–∞—Ç
    - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–π
    - –°–±—Ä–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
    –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç–∏:
    {
        "—Ç–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã 1": "2026-02-19",
        "—Ç–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã 2": "2026-02-18",
        ...
    }

–ê–≤—Ç–æ—Ä: kadannr
–í–µ—Ä—Å–∏—è: 1.0.0
"""

import json
import os
import datetime
import logging
from typing import Dict, List, Optional, Any, Set, Tuple
from pathlib import Path
from collections import defaultdict

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É –∏—Å—Ç–æ—Ä–∏–∏
from config import config

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–≥–µ—Ä –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
logger = logging.getLogger(__name__)


class PublicationHistory:
    """
    –ö–ª–∞—Å—Å –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–π —Ü–∏—Ç–∞—Ç.
    
    –≠—Ç–æ—Ç –∫–ª–∞—Å—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏ –±–æ—Ç–∞.
    –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ JSON —Ñ–∞–π–ª–µ, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏.
    
    Attributes:
        history_file (str): –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å –∏—Å—Ç–æ—Ä–∏–µ–π
        history (Dict[str, str]): –°–ª–æ–≤–∞—Ä—å {—Ç–µ–∫—Å—Ç_—Ü–∏—Ç–∞—Ç—ã: –¥–∞—Ç–∞_–ø—É–±–ª–∏–∫–∞—Ü–∏–∏}
        
    Example:
        >>> history = PublicationHistory()
        >>> history.mark_published("–ë—ã—Ç—å –∏–ª–∏ –Ω–µ –±—ã—Ç—å")
        >>> if history.is_published_recently("–ë—ã—Ç—å –∏–ª–∏ –Ω–µ –±—ã—Ç—å", days=30):
        ...     print("–ü—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π")
    """
    
    def __init__(self, history_file: Optional[str] = None):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–π.
        
        Args:
            history_file: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏—Å—Ç–æ—Ä–∏–∏. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –±–µ—Ä–µ—Ç—Å—è –∏–∑ config.
                         –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
        
        Note:
            –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∏—Å—Ç–æ—Ä–∏—è
            –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å, –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç.
        """
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏—Å—Ç–æ—Ä–∏–∏
        self.history_file = history_file or config.history_file
        logger.debug(f"–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–π, —Ñ–∞–π–ª: {self.history_file}")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∏—Å—Ç–æ—Ä–∏—é
        self.history: Dict[str, str] = {}
        self._load_history()
        
        logger.info(f"‚úÖ –ò—Å—Ç–æ—Ä–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–∞: {len(self.history)} –∑–∞–ø–∏—Å–µ–π")
    
    # =========================================================================
    # –ü–†–ò–í–ê–¢–ù–´–ï –ú–ï–¢–û–î–´ –†–ê–ë–û–¢–´ –° –§–ê–ô–õ–ê–ú–ò
    # =========================================================================
    
    def _load_history(self) -> None:
        """
        –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∏–∑ JSON —Ñ–∞–π–ª–∞.
        
        –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏:
            - –§–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—É—Å—Ç–∞—è –∏—Å—Ç–æ—Ä–∏—è
            - –§–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω (–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON) ‚Üí —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è
            - –û—à–∏–±–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ ‚Üí –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
        
        Note:
            –ü—Ä–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .bak,
            —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é.
        """
        history_path = Path(self.history_file)
        
        # ---------------------------------------------------------------------
        # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
        # ---------------------------------------------------------------------
        if not history_path.exists():
            logger.info(f"üìÅ –§–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π: {self.history_file}")
            self.history = {}
            return
        
        # ---------------------------------------------------------------------
        # –®–∞–≥ 2: –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
        # ---------------------------------------------------------------------
        try:
            with open(history_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            # -----------------------------------------------------------------
            # –®–∞–≥ 3: –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
            # -----------------------------------------------------------------
            if isinstance(data, dict):
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç
                valid_history = {}
                invalid_dates = 0
                
                for quote_text, date_str in data.items():
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
                    try:
                        datetime.datetime.strptime(date_str, '%Y-%m-%d')
                        valid_history[quote_text] = date_str
                    except (ValueError, TypeError):
                        invalid_dates += 1
                        logger.warning(f"‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –¥–ª—è —Ü–∏—Ç–∞—Ç—ã: {quote_text[:50]}... = {date_str}")
                
                self.history = valid_history
                
                if invalid_dates > 0:
                    logger.warning(f"‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ {invalid_dates} –∑–∞–ø–∏—Å–µ–π —Å –Ω–µ–≤–µ—Ä–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏")
                
                logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π: {len(self.history)} –∑–∞–ø–∏—Å–µ–π")
            else:
                # –î–∞–Ω–Ω—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è —Å–ª–æ–≤–∞—Ä–µ–º - –≤–æ–∑–º–æ–∂–Ω–æ —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
                logger.error(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∏—Å—Ç–æ—Ä–∏–∏: –æ–∂–∏–¥–∞–ª—Å—è dict, –ø–æ–ª—É—á–µ–Ω {type(data)}")
                self._backup_corrupted_file()
                self.history = {}
                
        except json.JSONDecodeError as e:
            # –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON - —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ–∞–π–ª–∞ –∏—Å—Ç–æ—Ä–∏–∏: {e}")
            logger.error(f"   –ü–æ–∑–∏—Ü–∏—è –æ—à–∏–±–∫–∏: —Å—Ç—Ä–æ–∫–∞ {e.lineno}, –∫–æ–ª–æ–Ω–∫–∞ {e.colno}")
            self._backup_corrupted_file()
            self.history = {}
            
        except PermissionError as e:
            # –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            logger.error(f"‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏—Å—Ç–æ—Ä–∏–∏: {e}")
            logger.error("üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É")
            self.history = {}
            
        except Exception as e:
            # –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞
            logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏: {e}")
            self.history = {}
    
    def _backup_corrupted_file(self) -> None:
        """
        –°–æ–∑–¥–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏—Å—Ç–æ—Ä–∏–∏.
        
        –ï—Å–ª–∏ —Ñ–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω, –º—ã —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –∫–æ–ø–∏—é —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .bak
        –∏ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é.
        """
        try:
            history_path = Path(self.history_file)
            if history_path.exists():
                # –°–æ–∑–¥–∞–µ–º –∏–º—è –¥–ª—è –±—ç–∫–∞–ø–∞ —Å –¥–∞—Ç–æ–π
                backup_name = f"{history_path}.{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.bak"
                history_path.rename(backup_name)
                logger.info(f"üíæ –°–æ–∑–¥–∞–Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: {backup_name}")
                logger.info("üí° –í—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ –≤—Ä—É—á–Ω—É—é")
        except Exception as e:
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é: {e}")
    
    def _save_history(self) -> bool:
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ø—É–±–ª–∏–∫–∞—Ü–∏–π –≤ JSON —Ñ–∞–π–ª.
        
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å
        –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏.
        
        Returns:
            bool: True –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ, False –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ
            
        Note:
            –ú–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
        """
        history_path = Path(self.history_file)
        
        try:
            # -----------------------------------------------------------------
            # –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
            # -----------------------------------------------------------------
            history_path.parent.mkdir(parents=True, exist_ok=True)
            
            # -----------------------------------------------------------------
            # –®–∞–≥ 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            # -----------------------------------------------------------------
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
            temp_file = history_path.with_suffix('.tmp')
            
            with open(temp_file, 'w', encoding='utf-8') as f:
                json.dump(
                    self.history, 
                    f, 
                    ensure_ascii=False,  # –°–æ—Ö—Ä–∞–Ω—è–µ–º Unicode –∫–∞–∫ –µ—Å—Ç—å
                    indent=2,             # –ö—Ä–∞—Å–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                    sort_keys=True        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª—é—á–∏ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
                )
            
            # -----------------------------------------------------------------
            # –®–∞–≥ 3: –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–º–µ–Ω–∞
            # -----------------------------------------------------------------
            # os.replace - –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–∞ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º
            os.replace(temp_file, history_path)
            
            logger.debug(f"üíæ –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {len(self.history)} –∑–∞–ø–∏—Å–µ–π")
            return True
            
        except PermissionError as e:
            logger.error(f"‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏: {e}")
            return False
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏: {e}")
            return False
    
    # =========================================================================
    # –ü–£–ë–õ–ò–ß–ù–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –ò–°–¢–û–†–ò–ï–ô
    # =========================================================================
    
    def is_published_recently(self, quote_text: str, days: int = 365) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å –ª–∏ —Ü–∏—Ç–∞—Ç–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π.
        
        Args:
            quote_text: –¢–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            days: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 365)
        
        Returns:
            True –µ—Å–ª–∏ —Ü–∏—Ç–∞—Ç–∞ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ, False –µ—Å–ª–∏ –Ω–µ—Ç
            
        Examples:
            >>> history.is_published_recently("–ë—ã—Ç—å –∏–ª–∏ –Ω–µ –±—ã—Ç—å", days=30)
            False  # –ù–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
            
            >>> history.is_published_recently("–ë—ã—Ç—å –∏–ª–∏ –Ω–µ –±—ã—Ç—å", days=365)
            True   # –ü—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥
        
        Note:
            –ï—Å–ª–∏ —Ü–∏—Ç–∞—Ç–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç False.
            –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç False (—Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å).
        """
        # ---------------------------------------------------------------------
        # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
        # ---------------------------------------------------------------------
        if quote_text not in self.history:
            logger.debug(f"–¶–∏—Ç–∞—Ç–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å: {quote_text[:50]}...")
            return False
        
        # ---------------------------------------------------------------------
        # –®–∞–≥ 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        # ---------------------------------------------------------------------
        last_date_str = self.history[quote_text]
        
        try:
            # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –∏–∑ —Å—Ç—Ä–æ–∫–∏
            last_date = datetime.datetime.strptime(last_date_str, '%Y-%m-%d').date()
            today = datetime.datetime.now().date()
            
            # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –¥–Ω—è—Ö
            days_diff = (today - last_date).days
            
            logger.debug(f"–¶–∏—Ç–∞—Ç–∞ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å {days_diff} –¥–Ω–µ–π –Ω–∞–∑–∞–¥")
            
            # -----------------------------------------------------------------
            # –®–∞–≥ 3: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø–µ—Ä–∏–æ–¥–æ–º
            # -----------------------------------------------------------------
            return days_diff < days
            
        except ValueError as e:
            # –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã - –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã '{last_date_str}' –¥–ª—è —Ü–∏—Ç–∞—Ç—ã: {e}")
            return False
    
    def mark_published(self, quote_text: str) -> bool:
        """
        –û—Ç–º–µ—á–∞–µ—Ç —Ü–∏—Ç–∞—Ç—É –∫–∞–∫ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—É—é —Å–µ–≥–æ–¥–Ω—è.
        
        Args:
            quote_text: –¢–µ–∫—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–π —Ü–∏—Ç–∞—Ç—ã
            
        Returns:
            bool: True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ, False –ø—Ä–∏ –æ—à–∏–±–∫–µ
            
        Example:
            >>> success = history.mark_published("–ë—ã—Ç—å –∏–ª–∏ –Ω–µ –±—ã—Ç—å")
            >>> if success:
            ...     print("–ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞")
        
        Note:
            –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –∏—Å—Ç–æ—Ä–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ñ–∞–π–ª.
            –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è False, –Ω–æ –∑–∞–ø–∏—Å—å –≤ –ø–∞–º—è—Ç–∏ –æ—Å—Ç–∞–µ—Ç—Å—è.
        """
        # ---------------------------------------------------------------------
        # –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
        # ---------------------------------------------------------------------
        today = datetime.datetime.now().date().isoformat()  # YYYY-MM-DD
        
        # ---------------------------------------------------------------------
        # –®–∞–≥ 2: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é
        # ---------------------------------------------------------------------
        self.history[quote_text] = today
        logger.info(f"üìù –û—Ç–º–µ—á–µ–Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—è: {quote_text[:50]}... -> {today}")
        
        # ---------------------------------------------------------------------
        # –®–∞–≥ 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª
        # ---------------------------------------------------------------------
        if self._save_history():
            logger.debug("–ò—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª")
            return True
        else:
            logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ —Ñ–∞–π–ª")
            return False
    
    def get_available_quotes(self, quotes: List[Dict[str, Any]], days: int = 365) -> List[Dict[str, Any]]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ü–∏—Ç–∞—Ç, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å.
        
        Args:
            quotes: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ü–∏—Ç–∞—Ç
            days: –ü–µ—Ä–∏–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –¥–Ω—è—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 365)
        
        Returns:
            –°–ø–∏—Å–æ–∫ —Ü–∏—Ç–∞—Ç, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏—Å—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ `days` –¥–Ω–µ–π
            
        Example:
            >>> all_quotes = load_quotes()
            >>> available = history.get_available_quotes(all_quotes, days=30)
            >>> print(f"–î–æ—Å—Ç—É–ø–Ω–æ {len(available)} —Ü–∏—Ç–∞—Ç –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏")
        
        Note:
            –¶–∏—Ç–∞—Ç—ã –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ —Å –ø—É—Å—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è.
        """
        available = []
        skipped = 0
        
        for quote in quotes:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã
            text = quote.get('text', '')
            
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ü–∏—Ç–∞—Ç—ã –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
            if not text:
                skipped += 1
                continue
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å –ª–∏ –Ω–µ–¥–∞–≤–Ω–æ
            if not self.is_published_recently(text, days):
                available.append(quote)
        
        if skipped > 0:
            logger.debug(f"–ü—Ä–æ–ø—É—â–µ–Ω–æ {skipped} —Ü–∏—Ç–∞—Ç –±–µ–∑ —Ç–µ–∫—Å—Ç–∞")
        
        logger.debug(f"–ù–∞–π–¥–µ–Ω–æ {len(available)} –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ü–∏—Ç–∞—Ç –∏–∑ {len(quotes)}")
        return available
    
    def get_stats(self) -> Dict[str, Any]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—É–±–ª–∏–∫–∞—Ü–∏–π.
        
        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç:
            - total: –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π
            - last_30_days: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
            - oldest: –î–∞—Ç–∞ —Å–∞–º–æ–π –ø–µ—Ä–≤–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
            - newest: –î–∞—Ç–∞ —Å–∞–º–æ–π –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
            - by_year: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≥–æ–¥–∞–º
            - by_month: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü–∞–º (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12)
        
        Returns:
            Dict —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–π
            
        Example:
            >>> stats = history.get_stats()
            >>> print(f"–í—Å–µ–≥–æ: {stats['total']}")
            >>> print(f"–ó–∞ –º–µ—Å—è—Ü: {stats['last_30_days']}")
        """
        # ---------------------------------------------------------------------
        # –®–∞–≥ 1: –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        # ---------------------------------------------------------------------
        total = len(self.history)
        
        if total == 0:
            return {
                "total": 0,
                "last_30_days": 0,
                "oldest": None,
                "newest": None,
                "by_year": {},
                "by_month": {}
            }
        
        # ---------------------------------------------------------------------
        # –®–∞–≥ 2: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–∞—Ç–∞–º
        # ---------------------------------------------------------------------
        today = datetime.datetime.now().date()
        last_30_days = 0
        dates = []
        years = defaultdict(int)
        months = defaultdict(int)
        
        for date_str in self.history.values():
            try:
                date = datetime.datetime.strptime(date_str, '%Y-%m-%d').date()
                dates.append(date)
                
                # –°—á–∏—Ç–∞–µ–º –ø–æ –≥–æ–¥–∞–º
                years[date.year] += 1
                
                # –°—á–∏—Ç–∞–µ–º –ø–æ –º–µ—Å—è—Ü–∞–º (–¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 12)
                month_key = date.strftime('%Y-%m')
                months[month_key] += 1
                
                # –°—á–∏—Ç–∞–µ–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
                if (today - date).days <= 30:
                    last_30_days += 1
                    
            except ValueError:
                continue
        
        # ---------------------------------------------------------------------
        # –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        # ---------------------------------------------------------------------
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–µ—Å—è—Ü—ã
        sorted_months = dict(sorted(months.items(), reverse=True)[:12])
        
        return {
            "total": total,
            "last_30_days": last_30_days,
            "oldest": min(dates).isoformat() if dates else None,
            "newest": max(dates).isoformat() if dates else None,
            "by_year": dict(years),
            "by_month": sorted_months
        }
    
    def reset_history(self) -> bool:
        """
        –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞.
        
        –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –æ –ø—É–±–ª–∏–∫–∞—Ü–∏—è—Ö –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –≤—Å–µ —Ü–∏—Ç–∞—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∏ –Ω—É–∂–Ω–æ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –≥–æ–¥–æ–≤–æ–π —Ü–∏–∫–ª.
        
        Returns:
            bool: True –µ—Å–ª–∏ —Å–±—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω, False –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            
        Example:
            >>> if history.reset_history():
            ...     print("–ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —Ü–∏–∫–ª!")
        
        Note:
            –ü–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –≤—Å–µ —Ü–∏—Ç–∞—Ç—ã —Å–Ω–æ–≤–∞ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
        """
        logger.warning("‚ö†Ô∏è –°–ë–†–û–° –ò–°–¢–û–†–ò–ò –ü–£–ë–õ–ò–ö–ê–¶–ò–ô!")
        
        # –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤ –ø–∞–º—è—Ç–∏
        self.history.clear()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª
        if self._save_history():
            logger.info("üìÜ –ò—Å—Ç–æ—Ä–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π —Å–±—Ä–æ—à–µ–Ω–∞ - –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –≥–æ–¥–æ–≤–æ–π —Ü–∏–∫–ª!")
            return True
        else:
            logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—É—Å—Ç—É—é –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞")
            return False
    
    def get_quote_history(self, quote_text: str) -> Optional[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ü–∏—Ç–∞—Ç—ã.
        
        Args:
            quote_text: –¢–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç—ã
            
        Returns:
            Optional[str]: –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD –∏–ª–∏ None, –µ—Å–ª–∏ –Ω–µ –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∞—Å—å
        """
        return self.history.get(quote_text)
    
    def get_quotes_published_on(self, date: datetime.date) -> List[str]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ü–∏—Ç–∞—Ç, –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É.
        
        Args:
            date: –î–∞—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
            
        Returns:
            List[str]: –°–ø–∏—Å–æ–∫ —Ç–µ–∫—Å—Ç–æ–≤ —Ü–∏—Ç–∞—Ç
        """
        date_str = date.isoformat()
        return [quote for quote, pub_date in self.history.items() if pub_date == date_str]
    
    def cleanup_old_entries(self, days: int = 730) -> int:
        """
        –£–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π.
        
        Args:
            days: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∑–∞–ø–∏—Å–µ–π –≤ –¥–Ω—è—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 730 = 2 –≥–æ–¥–∞)
            
        Returns:
            int: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
        """
        cutoff_date = datetime.datetime.now().date() - datetime.timedelta(days=days)
        removed = 0
        
        to_remove = []
        for quote_text, date_str in self.history.items():
            try:
                pub_date = datetime.datetime.strptime(date_str, '%Y-%m-%d').date()
                if pub_date < cutoff_date:
                    to_remove.append(quote_text)
            except ValueError:
                # –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ–ø–∞—Ä—Å–∏—Ç—Å—è, —Ç–æ–∂–µ —É–¥–∞–ª—è–µ–º –∫–∞–∫ "–º—É—Å–æ—Ä"
                to_remove.append(quote_text)
        
        for quote_text in to_remove:
            del self.history[quote_text]
            removed += 1
        
        if removed > 0:
            logger.info(f"üßπ –£–¥–∞–ª–µ–Ω–æ {removed} —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (> {days} –¥–Ω–µ–π)")
            self._save_history()
        
        return removed
    
    def export_to_csv(self, csv_file: str) -> bool:
        """
        –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –≤ CSV —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
        
        Args:
            csv_file: –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è CSV —Ñ–∞–π–ª–∞
            
        Returns:
            bool: True –µ—Å–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω
        """
        try:
            import csv
            
            with open(csv_file, 'w', encoding='utf-8', newline='') as f:
                writer = csv.writer(f)
                writer.writerow(['quote_text', 'publication_date'])
                
                for quote_text, date_str in sorted(self.history.items(), key=lambda x: x[1]):
                    writer.writerow([quote_text, date_str])
            
            logger.info(f"üìä –ò—Å—Ç–æ—Ä–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ CSV: {csv_file}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ CSV: {e}")
            return False


# =============================================================================
# –ì–õ–û–ë–ê–õ–¨–ù–´–ô –û–ë–™–ï–ö–¢ –ò–°–¢–û–†–ò–ò
# =============================================================================

# –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–æ –≤—Å–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
# –≠—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω Singleton - –≤—Å–µ –º–æ–¥—É–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç
history = PublicationHistory()

# –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏–º–ø–æ—Ä—Ç–∞: from history import history
# –¢–µ–ø–µ—Ä—å –ª—é–±–æ–π –º–æ–¥—É–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∏—Å—Ç–æ—Ä–∏–∏:
#   from history import history
#   history.mark_published("–ú–æ—è —Ü–∏—Ç–∞—Ç–∞")
# =============================================================================
# –ö–û–ù–ï–¶ –§–ê–ô–õ–ê
# =============================================================================