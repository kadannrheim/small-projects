#!/bin/bash
# =============================================================================
# get-real-digest.sh - –ü–û–õ–£–ß–ï–ù–ò–ï –†–ï–ê–õ–¨–ù–û–ì–û –ê–ö–¢–£–ê–õ–¨–ù–û–ì–û DIGEST
# =============================================================================
#
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø–æ–ª—É—á–∞–µ—Ç –Ω–∞—Å—Ç–æ—è—â–∏–π digest –¥–ª—è python:3.11-alpine
# –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç Dockerfile —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º.
#
# =============================================================================

echo "üîç –ü–û–õ–£–ß–ï–ù–ò–ï –ê–ö–¢–£–ê–õ–¨–ù–û–ì–û DIGEST –î–õ–Ø python:3.11-alpine"
echo "===================================================="

# –°–∫–∞—á–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –æ–±—Ä–∞–∑–∞
echo "üì¶ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ python:3.11-alpine..."
docker pull python:3.11-alpine

# –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π digest
REAL_DIGEST=$(docker inspect python:3.11-alpine | jq -r '.[0].RepoDigests[0]' | cut -d'@' -f2)

echo "‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω—ã–π digest: $REAL_DIGEST"

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
echo "$REAL_DIGEST" > current-alpine-digest.txt

# –û–±–Ω–æ–≤–ª—è–µ–º Dockerfile
if [ -f "Dockerfile.alpine" ]; then
    sed -i.bak "s|FROM python:3.11-alpine@sha256:[a-f0-9]*|FROM python:3.11-alpine@$REAL_DIGEST|" Dockerfile.alpine
    echo "‚úÖ Dockerfile.alpine –æ–±–Ω–æ–≤–ª–µ–Ω"
fi

echo ""
echo "üéâ –ì–û–¢–û–í–û! –ê–∫—Ç—É–∞–ª—å–Ω—ã–π digest: $REAL_DIGEST"
# =============================================================================
# –ö–û–ù–ï–¶ –§–ê–ô–õ–ê
# =============================================================================