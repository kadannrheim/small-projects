# docker-compose.yml
# =============================================================================
# DOCKER COMPOSE ДЛЯ TELEGRAM QUOTES BOT
# =============================================================================
#
# Этот файл описывает сервис для запуска бота в Docker контейнере.
# Особенности конфигурации:
#   - Автоматический перезапуск (unless-stopped)
#   - Сохранение данных через volumes
#   - Ротация логов Docker
#   - Запуск от непривилегированного пользователя
#   - Использование .env файла для конфигурации
#
# Использование:
#   docker-compose up -d        # Запуск в фоне
#   docker-compose logs -f      # Просмотр логов
#   docker-compose down         # Остановка
#   docker-compose restart      # Перезапуск
#
# Версия: 3.8 (поддержка современных фич Docker)
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # СЕРВИС: telegram-quotes
  # ---------------------------------------------------------------------------
  telegram-quotes:
    # Сборка из Dockerfile в директории ./quotes
    build: .
    
    # Имя контейнера для удобного обращения
    container_name: telegram-quotes-bot
    
    # -------------------------------------------------------------------------
    # ПОЛИТИКА ПЕРЕЗАПУСКА (RESTART POLICY)
    # -------------------------------------------------------------------------
    # unless-stopped означает:
    #   - Перезапускать при падении (ошибка, exit code != 0)
    #   - Перезапускать при перезагрузке сервера
    #   - НЕ перезапускать, если остановлен вручную (docker stop)
    # Это идеально для production сервисов
    restart: unless-stopped
    
    # -------------------------------------------------------------------------
    # ФАЙЛ С ПЕРЕМЕННЫМИ ОКРУЖЕНИЯ
    # -------------------------------------------------------------------------
    # Все настройки (токен, ID канала и т.д.) берутся из .env файла
    # Это позволяет не хардкодить секреты в docker-compose
    env_file:
      - .env
    
    # -------------------------------------------------------------------------
    # ПОДКЛЮЧЕНИЕ ДИРЕКТОРИЙ (VOLUMES)
    # -------------------------------------------------------------------------
    # Формат: "хост:контейнер"
    volumes:
      # Данные (цитаты, история) - сохраняются между перезапусками
      - ./data:/app/data
      
      # Логи - для централизованного сбора
      - ./logs:/app/logs
    
    # -------------------------------------------------------------------------
    # ЗАПУСК ОТ НЕПРИВИЛЕГИРОВАННОГО ПОЛЬЗОВАТЕЛЯ
    # -------------------------------------------------------------------------
    # Безопасность: не запускаем контейнер от root
    # 1000:1000 - типичный UID/GID первого пользователя в Linux
    # Если у вас другой UID, измените на свой (проверьте командой `id -u`)
    user: "1000:1000"
    
    # -------------------------------------------------------------------------
    # НАСТРОЙКИ ЛОГГИРОВАНИЯ DOCKER
    # -------------------------------------------------------------------------
    logging:
      # Используем стандартный json-file драйвер
      driver: "json-file"
      options:
        # Максимальный размер одного файла лога
        max-size: "10m"
        # Максимальное количество файлов лога
        max-file: "3"
        # Альтернативно можно использовать сжатие:
        # compress: "true"
    
    # -------------------------------------------------------------------------
    # ДОПОЛНИТЕЛЬНЫЕ НАСТРОЙКИ (опционально)
    # -------------------------------------------------------------------------
    # Ограничение ресурсов (рекомендуется для продакшена)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '0.5'      # Не более 50% CPU
    #       memory: 256M      # Не более 256 MB RAM
    #     reservations:
    #       cpus: '0.1'       # Минимум 10% CPU
    #       memory: 128M       # Минимум 128 MB RAM
    
    # Сети (если нужна изоляция)
    # networks:
    #   - bot_network
    
    # Проверка здоровья (healthcheck)
    # healthcheck:
    #   test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost')"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s

# Определение сетей (если нужно)
# networks:
#   bot_network:
#     driver: bridge
# =============================================================================
# КОНЕЦ ФАЙЛА
# =============================================================================