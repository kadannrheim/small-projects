#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Telegram Coaching Tools Bot - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ—É—á–∏–Ω–≥–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
================================================================================

–≠—Ç–æ—Ç –±–æ—Ç –ø—É–±–ª–∏–∫—É–µ—Ç –∫–æ—É—á–∏–Ω–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤ Telegram –∫–∞–Ω–∞–ª:
    - –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ JSON —Ñ–∞–π–ª–∞
    - –í—ã–±–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤ 365 –¥–Ω–µ–π)
    - –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram —Å –∫—Ä–∞—Å–∏–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    - 5 —Å—Å—ã–ª–æ–∫ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–Ø–Ω–¥–µ–∫—Å, Google, –í–∏–∫–∏–ø–µ–¥–∏—è, YouTube, RuTube)
    - –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π —Å–æ —Å–ª—É—á–∞–π–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º

–ê–≤—Ç–æ—Ä: kadannr
–í–µ—Ä—Å–∏—è: 1.0.0
"""

import json
import random
import schedule
import time
import signal
import sys
import datetime
import logging
from typing import List, Dict, Optional, Any
from pathlib import Path

# –ò–º–ø–æ—Ä—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
from config import config
from utils import setup_logger, graceful_shutdown
from history import history
from formatter import format_tool

# =============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ì–ï–†–ê
# =============================================================================

logger = setup_logger(__name__, config.log_level, config.log_file)
logger.info("=" * 60)
logger.info("üöÄ –ö–û–£–ß–ò–ù–ì–û–í–´–ô –ë–û–¢ –ó–ê–ü–£–©–ï–ù")
logger.info("=" * 60)


# =============================================================================
# –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
# =============================================================================

def load_tools() -> List[Dict[str, Any]]:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ—É—á–∏–Ω–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏–∑ JSON —Ñ–∞–π–ª–∞.
    
    Returns:
        List[Dict]: –°–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. –ö–∞–∂–¥—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç:
            - id: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
            - title: –ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            - content: –û–ø–∏—Å–∞–Ω–∏–µ
            - author: –ê–≤—Ç–æ—Ä
            - hashtags: –•—ç—à—Ç–µ–≥–∏
            - type: –¢–∏–ø (exercise, technique, tool)
            - duration_minutes: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö
            - difficulty: –°–ª–æ–∂–Ω–æ—Å—Ç—å (easy, medium, hard)
    """
    tools_path = Path(config.tools_file)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    # -------------------------------------------------------------------------
    if not tools_path.exists():
        logger.error(f"‚ùå –§–∞–π–ª —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: {tools_path.absolute()}")
        logger.info("üí° –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª coaching_tools.json –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ data/")
        logger.info("üí° –ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ –≤ .env.example")
        return []
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–∞—Ä—Å–∏–Ω–≥ JSON
    # -------------------------------------------------------------------------
    try:
        with open(tools_path, 'r', encoding='utf-8') as file:
            tools = json.load(file)
        
        logger.debug(f"–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, —Ç–∏–ø: {type(tools)}")
        
    except json.JSONDecodeError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
        logger.error(f"   –ü–æ–∑–∏—Ü–∏—è –æ—à–∏–±–∫–∏: —Å—Ç—Ä–æ–∫–∞ {e.lineno}, –∫–æ–ª–æ–Ω–∫–∞ {e.colno}")
        return []
    except PermissionError:
        logger.error(f"‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞: {tools_path}")
        return []
    except Exception as e:
        logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤: {e}")
        return []
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
    # -------------------------------------------------------------------------
    if not isinstance(tools, list):
        logger.error(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: –æ–∂–∏–¥–∞–ª—Å—è —Å–ø–∏—Å–æ–∫, –ø–æ–ª—É—á–µ–Ω {type(tools)}")
        return []
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 4: –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    # -------------------------------------------------------------------------
    valid_tools = []
    for idx, tool in enumerate(tools):
        if not isinstance(tool, dict):
            logger.warning(f"‚ö†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç #{idx} –ø—Ä–æ–ø—É—â–µ–Ω: –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å–ª–æ–≤–∞—Ä–µ–º")
            continue
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        required_fields = ['title', 'content']
        missing_fields = [field for field in required_fields if field not in tool]
        
        if missing_fields:
            logger.warning(f"‚ö†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç #{idx} –ø—Ä–æ–ø—É—â–µ–Ω: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª—è {missing_fields}")
            continue
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
        if 'author' not in tool or not tool['author']:
            tool['author'] = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä"
        
        if 'hashtags' not in tool or not tool['hashtags']:
            tool['hashtags'] = "#–∫–æ—É—á–∏–Ω–≥–æ–≤—ã–µ_–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"
        
        if 'type' not in tool:
            tool['type'] = "tool"
        
        if 'duration_minutes' not in tool:
            tool['duration_minutes'] = 0
        
        if 'difficulty' not in tool:
            tool['difficulty'] = "medium"
        
        # –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫–∏
        tool['title'] = tool['title'].strip()
        tool['content'] = tool['content'].strip()
        tool['author'] = tool['author'].strip()
        tool['hashtags'] = tool['hashtags'].strip()
        
        valid_tools.append(tool)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 5: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    # -------------------------------------------------------------------------
    if len(valid_tools) == 0:
        logger.error("‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ —Ñ–∞–π–ª–µ!")
    else:
        logger.info(f"‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(valid_tools)} –≤–∞–ª–∏–¥–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ {len(tools)}")
        
        if valid_tools and logger.isEnabledFor(logging.DEBUG):
            example = valid_tools[0]
            logger.debug(f"–ü—Ä–∏–º–µ—Ä: {example['title']} - {example['author']}")
    
    return valid_tools


# =============================================================================
# –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–í
# =============================================================================

def get_unique_tool(tools: List[Dict[str, Any]]) -> Optional[Dict[str, Any]]:
    """
    –í—ã–±–∏—Ä–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å –≥–∞—Ä–∞–Ω—Ç–∏–µ–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–æ–≤—Ç–æ—Ä–æ–≤ –≤ —Ç–µ—á–µ–Ω–∏–µ –≥–æ–¥–∞.
    
    Args:
        tools: –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        
    Returns:
        Optional[Dict]: –í—ã–±—Ä–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–ª–∏ None
    """
    if not tools:
        logger.warning("‚ö†Ô∏è –°–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø—É—Å—Ç")
        return None
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
    # -------------------------------------------------------------------------
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º title –∫–∞–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
    available_tools = history.get_available_quotes(tools, days=365, key_field='title')
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    # -------------------------------------------------------------------------
    total_tools = len(tools)
    used_tools = total_tools - len(available_tools)
    usage_percent = (used_tools / total_tools) * 100 if total_tools > 0 else 0
    
    logger.info(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–∏–∫–ª–∞: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ {used_tools}/{total_tools} –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ ({usage_percent:.1f}%)")
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    # -------------------------------------------------------------------------
    if available_tools:
        selected_tool = random.choice(available_tools)
        logger.info(f"‚úÖ –í—ã–±—Ä–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: {selected_tool['title']}")
        return selected_tool
    
    # –ï—Å–ª–∏ –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã - –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π —Ü–∏–∫–ª
    logger.info("üîÑ –í—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã! –ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π –≥–æ–¥–æ–≤–æ–π —Ü–∏–∫–ª...")
    history.reset_history()
    
    selected_tool = random.choice(tools)
    logger.info(f"‚úÖ –í—ã–±—Ä–∞–Ω –ø–µ—Ä–≤—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞: {selected_tool['title']}")
    
    return selected_tool


# =============================================================================
# –û–¢–ü–†–ê–í–ö–ê –í TELEGRAM
# =============================================================================

def send_tool() -> bool:
    """
    –í—ã–±–∏—Ä–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ Telegram –∫–∞–Ω–∞–ª.
    
    Returns:
        bool: True –µ—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞
    """
    import requests
    
    logger.info("=" * 40)
    logger.info("üì§ –ù–ê–ß–ê–õ–û –ü–£–ë–õ–ò–ö–ê–¶–ò–ò –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê")
    logger.info("=" * 40)
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    # -------------------------------------------------------------------------
    tools = load_tools()
    
    if not tools:
        logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã")
        return False
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 2: –í—ã–±–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    # -------------------------------------------------------------------------
    tool_data = get_unique_tool(tools)
    
    if not tool_data:
        logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç")
        return False
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 3: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    # -------------------------------------------------------------------------
    formatted_tool = format_tool(tool_data)
    
    logger.info(f"üìù –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: {tool_data['title']}")
    
    # -------------------------------------------------------------------------
    # –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
    # -------------------------------------------------------------------------
    url = f'https://api.telegram.org/bot{config.tg_coaching_bot_token}/sendMessage'
    
    payload = {
        'chat_id': config.tg_coaching_channel_id,
        'text': formatted_tool,
        'parse_mode': 'HTML',
        'disable_web_page_preview': True
    }
    
    if config.disable_notifications:
        payload['disable_notification'] = True
    
    try:
        logger.debug(f"–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Telegram API")
        
        response = requests.post(
            url, 
            data=payload, 
            timeout=config.request_timeout
        )
        
        if response.status_code == 200:
            result = response.json()
            
            if result.get('ok'):
                logger.info(f"‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: {tool_data['title']}")
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é (–∏—Å–ø–æ–ª—å–∑—É–µ–º title –∫–∞–∫ –∫–ª—é—á)
                history.mark_published(tool_data['title'])
                
                stats = history.get_stats()
                logger.info(f"üìà –í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π: {stats['total']}")
                
                logger.info("=" * 40)
                logger.info("‚úÖ –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û")
                logger.info("=" * 40)
                
                return True
            else:
                error_desc = result.get('description', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')
                logger.error(f"‚ùå Telegram API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: {error_desc}")
        else:
            logger.error(f"‚ùå HTTP –æ—à–∏–±–∫–∞: {response.status_code}")
            logger.error(f"–û—Ç–≤–µ—Ç API: {response.text[:200]}")
        
    except requests.exceptions.Timeout:
        logger.error("‚ùå –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞")
    except requests.exceptions.ConnectionError:
        logger.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Telegram API")
    except Exception as e:
        logger.error(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
        logger.exception("–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:")
    
    logger.error("=" * 40)
    logger.error("‚ùå –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ù–ï –£–î–ê–õ–ê–°–¨")
    logger.error("=" * 40)
    
    return False


# =============================================================================
# –ü–õ–ê–ù–ò–†–û–í–©–ò–ö –ü–£–ë–õ–ò–ö–ê–¶–ò–ô
# =============================================================================

def schedule_random_time() -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
    """
    random_offset = random.randint(-config.random_range_minutes, config.random_range_minutes)
    
    base_minutes = config.base_hour * 60 + config.base_minute
    total_minutes = base_minutes + random_offset
    
    total_minutes = max(0, min(total_minutes, 23 * 60 + 59))
    
    target_hour = total_minutes // 60
    target_minute = total_minutes % 60
    target_time = f"{target_hour:02d}:{target_minute:02d}"
    
    offset_sign = '+' if random_offset >= 0 else ''
    logger.info(f"üïí –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤—Ä–µ–º—è: {target_time} (—Å–º–µ—â–µ–Ω–∏–µ: {offset_sign}{random_offset} –º–∏–Ω)")
    
    return target_time


def setup_daily_schedule() -> str:
    """
    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.
    """
    schedule.clear()
    random_time = schedule_random_time()
    schedule.every().day.at(random_time).do(send_tool)
    logger.info(f"üìÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ {random_time}")
    return random_time


# =============================================================================
# –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø
# =============================================================================

def main():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.
    """
    signal.signal(signal.SIGINT, graceful_shutdown)
    signal.signal(signal.SIGTERM, graceful_shutdown)
    
    logger.info("=" * 60)
    logger.info("ü§ñ –ó–ê–ü–£–°–ö –ö–û–£–ß–ò–ù–ì–û–í–û–ì–û –ë–û–¢–ê")
    logger.info("=" * 60)
    
    # -------------------------------------------------------------------------
    # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    # -------------------------------------------------------------------------
    logger.info(f"üìÖ –ë–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è: {config.base_hour:02d}:{config.base_minute:02d}")
    logger.info(f"üé≤ –°–ª—É—á–∞–π–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: ¬±{config.random_range_minutes} –º–∏–Ω—É—Ç")
    logger.info(f"üìÅ –§–∞–π–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤: {config.tools_file}")
    logger.info(f"üìÅ –§–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏: {config.history_file}")
    
    # -------------------------------------------------------------------------
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    # -------------------------------------------------------------------------
    try:
        config.validate()
        logger.info("‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
    except ValueError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
        sys.exit(1)
    
    # -------------------------------------------------------------------------
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    # -------------------------------------------------------------------------
    tools = load_tools()
    if not tools:
        logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã! –ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")
        sys.exit(1)
    
    # -------------------------------------------------------------------------
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
    # -------------------------------------------------------------------------
    stats = history.get_stats()
    logger.info(f"üìä –ò—Å—Ç–æ—Ä–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π: –≤—Å–µ–≥–æ {stats['total']} –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤")
    
    # -------------------------------------------------------------------------
    # –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
    # -------------------------------------------------------------------------
    if config.send_test_tool:
        logger.info("üß™ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞...")
        if send_tool():
            logger.info("‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ")
        else:
            logger.warning("‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å")
    else:
        logger.info("‚è≠Ô∏è –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞")
    
    # -------------------------------------------------------------------------
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    # -------------------------------------------------------------------------
    today_time = setup_daily_schedule()
    logger.info(f"‚úÖ –°–µ–≥–æ–¥–Ω—è—à–Ω—è—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞: {today_time}")
    
    # -------------------------------------------------------------------------
    # –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ
    # -------------------------------------------------------------------------
    last_check_date = datetime.datetime.now().date()
    
    logger.info("=" * 60)
    logger.info("‚úÖ –ë–û–¢ –ó–ê–ü–£–©–ï–ù –ò –û–ñ–ò–î–ê–ï–¢ –ü–£–ë–õ–ò–ö–ê–¶–ò–ô")
    logger.info("=" * 60)
    
    while True:
        try:
            current_date = datetime.datetime.now().date()
            
            if current_date != last_check_date:
                logger.info("üìÖ –ù–æ–≤—ã–π –¥–µ–Ω—å! –ü–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä—É—é...")
                new_time = setup_daily_schedule()
                logger.info(f"‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–∞: {new_time}")
                last_check_date = current_date
            
            schedule.run_pending()
            time.sleep(60)
            
        except KeyboardInterrupt:
            logger.info("üëã –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è, –∑–∞–≤–µ—Ä—à–∞—é —Ä–∞–±–æ—Ç—É...")
            break
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ: {e}")
            time.sleep(60)


# =============================================================================
# –¢–û–ß–ö–ê –í–•–û–î–ê
# =============================================================================

if __name__ == "__main__":
    main()